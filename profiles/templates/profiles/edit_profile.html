{% extends 'base.html' %}
{% load static %}
{% load main_tags %}
{% block content %}
<!-- jQuery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/gijgo@1.9.14/js/gijgo.min.js" type="text/javascript"></script>
<link href="https://cdn.jsdelivr.net/npm/gijgo@1.9.14/css/gijgo.min.css" rel="stylesheet" type="text/css"/>
<script src="https://unpkg.com/gijgo@1.9.14/js/messages/messages.ru-ru.js" type="text/javascript"></script>
<style>
    .alert {
        position: fixed; /* Фиксированное положение */
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        width: 300px;
        z-index: 9999;
    }
</style>

<div id="alerts"></div>
<div class="container mt-5">
    <h2>Edit Profile</h2>
    <div class="">
        <button onclick="showSection('basic_info')">Basic Info</button>
        <button onclick="showSection('avatar')">Avatar</button>
        <button onclick="showSection('about_me')">About Me</button>
        <button onclick="showSection('change_email')">Change Email</button>
        <button onclick="showSection('change_password')">Change Password</button>
    </div>
    <div>
        <form name="profileForm" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div id="basic_info_section" style="display: none;">
                <div id="nameFields">
                    <br>
                    <label for="lastName">Last name:</label>
                    <input id="lastName" type="text" name="last_name" maxlength="100"
                           value="{{ form.instance.full_name | get_name2 }}"
                           class="form-control" oninput="updateFullName()">
                    <br>
                    <label for="firstName">First name:</label>
                    <input id="firstName" type="text" name="first_name" maxlength="100"
                           value="{{ form.instance.full_name | get_name }}"
                           class="form-control" oninput="updateFullName()">
                    <br>
                    <label for="middleName">Middle name:</label>
                    <input id="middleName" type="text" name="middle_name" maxlength="100"
                           value="{{ form.instance.full_name | get_middle_name }}"
                           class="form-control" oninput="updateFullName()">
                </div>
                <div style="display:none;">
                    <label for="full_name">Full Name:</label><br>
                    <input id="full_name" type="text" name="full_name" maxlength="300"
                           value="{{ form.instance.full_name }}">
                </div>

                <div class="mb-3">
                    <label for="sex" class="form-label">Sex:</label>
                    <select id="sex" name="sex" class="form-select">
                        <option value="M" {% if form.instance.sex == 'M' %} selected {% endif %}>Male</option>
                        <option value="F" {% if form.instance.sex == 'F' %} selected {% endif %}>Female</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="country" class="form-label">Country:</label>
                    <select id="country" name="country" class="form-select">
                        {% for country in form.country.field.queryset %}
                        <option value="{{ country.id }}" {% if country.id == form.instance.country.id %}
                                selected {% endif %}>{{ country.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div id="city_div" class="mb-3">
                    <label for="city" class="form-label">City:</label>
                    <select id="city" name="city" class="form-select" onclick="loadCities()">
                        <option value="{{ form.instance.city.id }}">{{form.instance.city.name}}</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="birth_date" class="form-label">Birth Date:</label>
                    <input id="birth_date" type="text" name="birth_date" class="form-control"
                           value="{{ form.instance.birth_date }}">
                </div>
            </div>
            <div id="avatar_section" style="display: none;">
                <div class="mb-3">
                    <label for="avatar" class="form-label">Avatar:</label>
                    <br>
                    <img id="avatarPreview" src="{{ form.instance.avatar.url }}" alt="Avatar Preview"
                         class="avatar-preview img-thumbnail " style="max-height: 500px; max-width: 500px;">
                    <input id="avatar" type="file" name="avatar" class="form-control" onchange="previewAvatar()">
                </div>
            </div>
            <div id="about_me_section" style="display: none;">
                <div class="mb-3">
                    <label for="bio" class="form-label">Bio:</label>
                    <textarea id="bio" name="bio" rows="3" class="form-control">{{form.instance.bio}}</textarea>
                </div>
            </div>
            <button name="profileForm" type="submit">Save</button>
            <a href="">Cancel</a>
        </form>
        <div id="change_email_section" style="display: none;">
            <!-- Change Password Fields -->
            <!-- Add your change password fields here -->
        </div>
        <div id="change_password_section" style="display: none;">
            <form name="changePasswordForm" method="post">
                {% csrf_token %}
                <!-- Форма смены пароля -->
                {{ change_password_form.as_p }}
                <button name="change_password_button" type="submit">Change Password</button>
            </form>
        </div>
    </div>
</div>

<script>
    var currentSection = null;

    function showSection(sectionName) {
        if (currentSection !== null) {
            currentSection.style.display = 'none';
        }

        var newSection = document.getElementById(sectionName + '_section');

        newSection.style.display = 'block';
        currentSection = newSection;
    }
</script>
<script>
    function loadCities() {
        var country_name = $('#country').val();
        $.ajax({
            url: "/api/get_cities_by_country/" + country_name + "/",
            type: "GET",
            success: function (data) {
                var citySelect = $('#city');
                var selectedCityId = citySelect.val(); // Сохраняем ID выбранного города, если есть

                citySelect.empty();

                $.each(data, function (index, city) {
                    citySelect.append($('<option>', {
                        value: city.id,
                        text: city.name
                    }));
                });

                if (selectedCityId) { // Если был выбран город, устанавливаем его после загрузки данных
                    citySelect.val(selectedCityId);
                }

                $('#city_div').show();
            },
            error: function (xhr, errmsg, err) {
                console.log(xhr.status + ": " + xhr.responseText); // Отображение ошибки в консоли браузера
            }
        });
    }
</script>
<script src="{% static 'js/get_cities_country.js' %}"></script>
<script src="{% static 'js/make_full_name.js' %}"></script>
<script src="{% static 'js/preview_avatar.js' %}"></script>
<script src="{% static 'js/datepicker.js' %}"></script>
<script src="{% static 'js/validation_edit_forms.js'%}"></script>
{% endblock %}
